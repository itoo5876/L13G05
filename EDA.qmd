---
title: "Assignment 1"
date: "`r Sys.Date()`"
author: "SID: 520473959"
format: 
  html: 
    embed-resources: true # Creates a single HTML file as output
    code-fold: true # Code folding; allows you to show/hide code chunks
    code-tools: true # Includes a menu to download the code file 
    self-contained: true
    # code-tools are particularly important if you use inline R to 
    # improve the reproducibility of your report
table-of-contents: true # (Optional) Creates a table of contents
number-sections: true # (Optional) Puts numbers next to heading/subheadings
number-tables: true # Puts numbers with table captions
bibliography: report.bib
csl: apa-5th-edition.csl

link-citations: true
---

```{r setup, include=TRUE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(janitor)
library(hms)
library(here)
library(gt)
library(ggplot2)
library(patchwork)
library(ggpubr)
library(knitr)
d1=read.table("student-mat.csv",sep=";",header=TRUE)
```

# EDA

## Data Reading and Visualization of Dependent Variable (Final Grade)

```{r}
# Read in Data and merge Portuguese and Math 
d1=read.table("student-por.csv",sep=";",header=TRUE)
d2=read.table("student-mat.csv",sep=";",header=TRUE)

d3=merge(d1,d2,by=c("school","sex","age","address","famsize","Pstatus","Medu","Fedu","Mjob","Fjob","reason","nursery","internet"))

# Produce histogram of final grade (G3)
p1 <- ggplot(d1) + 
  # add the aesthetics
  aes(x = G3) +
  # add a geometry
  geom_histogram(binwidth = 1, fill = "skyblue", color = "black") +  
  labs(x = "Final Grade (G3)", y = "Count")+
  theme_gray(base_size = 14)

 p1 + plot_layout(guides = 'collect')
```

```{r}
# Produce Density Plot
p2<- d1|>
  ggplot() + 
  aes(x = G3) + 
  labs(x='Final Grade (G3)')+
  geom_density(bw=2,alpha = 0.7,colour='skyblue',fill='skyblue')+
   theme(        axis.text.x=element_text(size=16),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=20),
        axis.title.y=element_text(size=20),
        legend.title=element_text(size=20),
        legend.text=element_text(size=20))+
  theme_gray(base_size = 14)

 p2 + plot_layout(guides = 'collect')
```

```{r fig.height=6, fig.width=6}
# Produce boxplot
p3 <-  ggplot(d1,aes(x="",y = G3)) + 
  geom_boxplot(fill = "skyblue", color = "black",width=0.3) +
  labs(
    y = "Final Grade (G3)",
    x="")+
  theme_gray(base_size = 14)+
     theme(        axis.text.x=element_text(size=16),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=20),
        axis.title.y=element_text(size=20),
        legend.title=element_text(size=20),
        legend.text=element_text(size=20))
 p3 + plot_layout(guides = 'collect')
```

## Relationship between Final Grade and other variables

### Absences vs final grade
```{r}
# Produce scatter plot for absence and final grade relationship
p4<- ggplot(d1,aes(x=absences,y=G3))+
  geom_point(colour='skyblue')+
  labs(
    y = "Final Grade (G3)",
    x = 'Number of Absences') +
  theme_gray(base_size = 14)+
     theme(        axis.text.x=element_text(size=16),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=20),
        axis.title.y=element_text(size=20),
        legend.title=element_text(size=20),
        legend.text=element_text(size=20))
 p4 + plot_layout(guides = 'collect')
  

```
### Gender vs final grade
```{r fig.height=6, fig.width=6}
# Produce side by side boxplots
p5<- ggplot(d1, aes(x=sex,y=G3,fill=sex))+
  geom_boxplot()+
  labs(x="Gender",
       y="Final Grade (G3)",
       fill='Gender')+
  theme_gray(base_size = 14)+
       theme(axis.text.x=element_text(size=16),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=20),
        axis.title.y=element_text(size=20),
        legend.title=element_text(size=20),
        legend.text=element_text(size=20))+
  scale_fill_manual(values = c("F" = "skyblue", "M" = "tomato"))
 p5 + plot_layout(guides = 'collect')
```
```{r}
d1$studytime <- factor(d1$studytime,
                       levels = c(1, 2, 3, 4),
                       labels = c("<2 hours", "2–5 hours", "5–10 hours", ">10 hours"))

p6<-ggplot(d1, aes(x = studytime, y = G3, fill = studytime)) +
  geom_boxplot() +
  labs(
       x = "Weekly Study Time",
       y = "Final Grade (G3)",
       fill='Studytime') +
  theme_minimal(base_size = 14)+
  theme(legend.position = "none")
 p6 + plot_layout(guides = 'collect')

```

## Linear Models

# Model 1: Null model, 
```{r}
# Set any characters to factors
d1[sapply(d1, is.character)] <- lapply(d1[sapply(d1, is.character)], as.factor)



# Compute correlation matrix for numeric variables
num_vars <- sapply(d1, is.numeric)
corr <- cor(d1[, num_vars], use = "complete.obs")

library(ggcorrplot)

num_vars <- sapply(d1, is.numeric)
cor_mat <- cor(d1[, num_vars], use = "complete.obs")

melted_cor_mat = cor_mat |>
  data.frame() |> 
  rownames_to_column(var = "var1") |> 
  pivot_longer(cols = -var1, 
               names_to = "var2",
               values_to = "cor")

melted_cor_mat |> ggplot() + 
  aes(x=var1, y=var2, fill=cor) + 
  geom_tile() + 
  theme_minimal() +
  scale_fill_gradient2(
    low = "lightblue", 
    high = "navy", 
    mid = "white", 
    midpoint = 0, 
    limit = c(-1,1)) +
  theme(
    axis.text.x = element_text(
      angle = 90, hjust = 1
    )
  )
```

```{r}
library(ggplot2)

# list of categorical/binary predictors
predictors <- c("school", "address", "famsize", "guardian", "Pstatus", 
                "Mjob", "Fjob", "schoolsup", "famsup", "paid", 
                "nursery", "internet")

# loop to create a boxplot for each variable
for (var in predictors) {
  p <- ggplot(d1, aes_string(x = var, y = "G3", fill = var)) +
    geom_boxplot(alpha = 0.8, outlier.shape = 21, outlier.size = 1.5) +
    scale_fill_manual(values = c("navy", "lightblue",'steelblue','blue','skyblue')) +
    theme_minimal(base_size = 14) +
    labs(title = paste("Effect of", var, "on Final Grade (G3)"),
         x = var,
         y = "Final Grade (G3)") +
    theme(
      legend.position = "none",
      plot.title = element_text(size = 12, face = "bold"),
      axis.text.x = element_text(angle = 45, hjust = 1)
    )
  
  print(p)
}


```



```{r}
library(ggplot2)

# Parent Education: combine or plot separately
ggplot(d1, aes(x = Medu, y = G3)) +
  geom_jitter(width = 0.2, alpha = 0.5,colour='blue') +
  geom_smooth(method = "lm", se = TRUE, colour = "navy") +
  theme_minimal(base_size = 14) +
  labs(title = "Mother's Education vs Final Grade (G3)",
       x = "Mother's Education Level (0–4)",
       y = "Final Grade (G3)")

ggplot(d1, aes(x = Fedu, y = G3)) +
  geom_jitter(width = 0.2, alpha = 0.5,colour='blue') +
  geom_smooth(method = "lm", se = TRUE, colour = "navy") +
  theme_minimal(base_size = 14) +
  labs(title = "Father's Education vs Final Grade (G3)",
       x = "Father's Education Level (0–4)",
       y = "Final Grade (G3)")

ggplot(d1, aes(x = famrel, y = G3)) +
  geom_jitter(width = 0.2, alpha = 0.5, colour = "blue") +
  geom_smooth(method = "lm", se = TRUE, colour = "navy") +
  theme_minimal(base_size = 14) +
  labs(title = "Family Relationship Quality vs Final Grade (G3)",
       x = "Family Relationship Quality (1–5)",
       y = "Final Grade (G3)")

ggplot(d1, aes(x = freetime, y = G3)) +
  geom_jitter(width = 0.2, alpha = 0.5, colour = "blue") +
  geom_smooth(method = "lm", se = TRUE, colour = "navy") +
  theme_minimal(base_size = 14) +
  labs(title = "Free Time vs Final Grade (G3)",
       x = "Free Time (1–5)",
       y = "Final Grade (G3)")

ggplot(d1, aes(x = health, y = G3)) +
  geom_jitter(width = 0.2, alpha = 0.5, colour = "blue") +
  geom_smooth(method = "lm", se = TRUE, colour = "navy") +
  theme_minimal(base_size = 14) +
  labs(title = "Health vs Final Grade (G3)",
       x = "Health Status (1–5)",
       y = "Final Grade (G3)")

```

```{r}
# Simple
simple=lm(G3~Fedu+Medu,data=d1)
summary(simple)
cv_simple=train(formula(simple),d1,method='lm',trControl=trainControl(method='cv',number=10,verboseIter=FALSE))
autoplot(simple,which=1:2)
# Null and Full
# Model 1 (Full)
null_mod <- lm(G3 ~ 1, data = d1)
full_mod <- lm(G1 ~ school+address+famsize+Pstatus+Mjob+Fjob+guardian+internet+schoolsup+famsup+paid+nursery+Medu+Fedu+famrel+freetime+health, data = d1)

lm_full=lm(G3~.,data=d1)
# Model 1 Assumptions check
autoplot(full_mod,which=1:2)

# Model 1 Performance evaluation
library(caret)
cv_full=train(G3 ~ school+address+famsize+Pstatus+Mjob+Fjob+guardian+internet+schoolsup+famsup+paid+nursery+Medu+Fedu+famrel+freetime+health,d1,method='lm',trControl=trainControl(method='cv',number=10,verboseIter=FALSE))


# Model 2 Backwards Selection
step.back.aic = step(full_mod, 
                     direction = "backward", 
                     trace = FALSE)
round(summary(step.back.aic)$coef,3)

# Model 2 assumptions check
autoplot(step.back.aic,which=1:2)

# Model 2 Performance evaluation
cv_back_aic=train(formula(step.back.aic),d1,method='lm',trControl=trainControl(method='cv',number=10,verboseIter=FALSE))


# Model 3 forward step with only fedu and medu
lm3_base = lm(G3 ~ Fedu+Medu, data = d1)
step.forward.aic = step(lm3_base, scope=list(lower=lm3_base,upper=full_mod),
                     direction = "forward", 
                     trace = FALSE)

# Check lm3 assumptions
autoplot(lm3,which=1:2)

# Model 3 Performance eval
cv_lm3=train(formula(lm3),d1,method='lm',trControl=trainControl(method='cv',number=10,verboseIter=FALSE))

# Try exhaustive search
library(lmSubsets)

exh <- lmSubsets(formula(full_mod), data = d1, nbest = 2)

plot(exh)
summary_exh=summary(exh)

```
